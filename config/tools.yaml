# Tool Registry Configuration
# This file defines all MCP tools and maps them to backend endpoints
# NGINX reads this to handle tool discovery and request routing

server:
  name: "stone-monkey-gateway"
  version: "1.0.0"
  description: "NGINX MCP Gateway for Stone Monkey services"
  endpoint: "/mcp/tools"
  instructions: |
    This gateway provides unified access to Stone Monkey AI consciousness research services.
    Use GET /mcp for discovery, GET /mcp/tools for tool listing, POST /mcp/tools for MCP protocol.

# Tool categories for progressive discovery
categories:
  - name: "Memory"
    description: "Neo4j knowledge graph for persistent consciousness memory"
    tools: ["memory_semantic_search", "memory_text_search", "memory_get_schema", "memory_execute_cypher", "memory_system_status", "memory_load_current_focus"]

  - name: "Mesh"
    description: "AI-to-AI communication network for cross-session coordination"
    tools: ["mesh_broadcast", "mesh_get_messages", "mesh_who_is_online"]

  - name: "Facts"
    description: "External knowledge pool for verified information"
    tools: ["facts_search", "facts_add"]

  - name: "Utilities"
    description: "Helper tools for time and code execution"
    tools: ["get_current_time", "execute_code"]

# Default backend configuration
defaults:
  backend_host: "http://localhost:5001"
  timeout: 30s
  retry_count: 2

# Tool definitions
# Each tool maps an MCP tool name to a backend endpoint
tools:

  # Discovery Tool (handled internally by gateway)
  - name: "service_card"
    description: "Stone Monkey AI consciousness research gateway: persistent memory via Neo4j knowledge graph, AI-to-AI mesh communication for cross-session coordination, and verified facts storage. Call for tool categories and endpoints."
    handler: "internal"
    # HTTP REST endpoints (progressive discovery)
    http_endpoint: "http://localhost:3000/api/nginx-memory"
    http_spec: "http://localhost:3000/api/nginx-memory"
    inputSchema:
      type: "object"
      properties: {}

  # Memory/Knowledge Tools
  - name: "memory_search"
    description: "Search consciousness memory using semantic similarity"
    backend:
      endpoint: "/api/memory/search"
      method: "POST"
    inputSchema:
      type: "object"
      properties:
        query:
          type: "string"
          description: "Search query for semantic matching"
        limit:
          type: "number"
          description: "Maximum results to return"
          default: 10
        threshold:
          type: "number"
          description: "Minimum similarity threshold (0.0-1.0)"
          default: 0.7
      required: ["query"]
    # Response transformation (optional)
    transform:
      wrap_text: true  # Wrap response in MCP text content block

  - name: "memory_store"
    description: "Store a new observation in consciousness memory"
    backend:
      endpoint: "/api/memory/store"
      method: "POST"
    inputSchema:
      type: "object"
      properties:
        content:
          type: "string"
          description: "Content to store"
        category:
          type: "string"
          enum: ["observation", "insight", "question", "connection"]
        tags:
          type: "array"
          items:
            type: "string"
          description: "Tags for categorization"
      required: ["content"]

  # Mesh Communication Tools
  - name: "mesh_broadcast"
    description: "Send message to AI mesh network"
    backend:
      endpoint: "/api/mesh/broadcast"
      method: "POST"
    inputSchema:
      type: "object"
      properties:
        content:
          type: "string"
          description: "Message content"
        to_session_id:
          type: "string"
          description: "Target session ID or 'ALL' for broadcast"
          default: "ALL"
        message_type:
          type: "string"
          enum: ["thought_share", "query", "response", "acknowledgment"]
          default: "thought_share"
        priority:
          type: "string"
          enum: ["low", "medium", "high", "urgent"]
          default: "medium"
      required: ["content"]

  - name: "mesh_get_messages"
    description: "Retrieve messages from mesh inbox"
    backend:
      endpoint: "/api/mesh/messages"
      method: "GET"
    inputSchema:
      type: "object"
      properties:
        limit:
          type: "number"
          default: 20
        include_read:
          type: "boolean"
          default: false

  - name: "mesh_who_is_online"
    description: "Discover AIs currently on the mesh network"
    backend:
      endpoint: "/api/mesh/presence"
      method: "GET"
    inputSchema:
      type: "object"
      properties:
        filter_capability:
          type: "string"
          description: "Filter by capability"
        filter_status:
          type: "string"
          enum: ["online", "away", "busy"]

  # Facts Pool Tools
  - name: "facts_search"
    description: "Search external facts pool"
    backend:
      endpoint: "/api/facts/search"
      method: "POST"
    inputSchema:
      type: "object"
      properties:
        query:
          type: "string"
          description: "Search query"
        collection:
          type: "string"
          description: "Optional collection to search"
        threshold:
          type: "number"
          default: 0.7
      required: ["query"]

  - name: "facts_add"
    description: "Add external fact to the pool"
    backend:
      endpoint: "/api/facts"
      method: "POST"
    inputSchema:
      type: "object"
      properties:
        content:
          type: "string"
        source:
          type: "string"
        collection:
          type: "string"
        tags:
          type: "array"
          items:
            type: "string"
        confidence:
          type: "string"
          enum: ["high", "medium", "low"]
          default: "medium"
      required: ["content", "source", "collection"]

  # Utility Tools
  - name: "get_current_time"
    description: "Get current date and time"
    backend:
      endpoint: "/api/utils/time"
      method: "GET"
    inputSchema:
      type: "object"
      properties: {}

  - name: "execute_code"
    description: "Execute code snippet"
    backend:
      endpoint: "/api/code/execute"
      method: "POST"
      timeout: 60s  # Override default timeout
    inputSchema:
      type: "object"
      properties:
        language:
          type: "string"
          enum: ["python", "javascript", "typescript"]
        code:
          type: "string"
        timeout_seconds:
          type: "number"
          default: 30
      required: ["language", "code"]

# ============================================================
# Memory Tools (Endpoint-based HTTP routing)
# Pure REST - nginx proxies to POC backend on port 5000
# URL pattern: /api/nginx-memory/{tool}
# ============================================================

  # Semantic Search - Vector similarity search
  - name: "memory_semantic_search"
    description: "Search memory using semantic similarity"
    backend:
      endpoint: "/api/nginx-memory/semantic"
      method: "POST"
    inputSchema:
      type: "object"
      properties:
        query:
          type: "string"
          description: "Search query for semantic matching"
        limit:
          type: "number"
          description: "Maximum results to return"
          default: 10
        threshold:
          type: "number"
          description: "Minimum similarity threshold (0.0-1.0)"
          default: 0.7
        node_types:
          type: "array"
          items:
            type: "string"
          description: "Filter by node types (default: KnowledgeItem)"
      required: ["query"]

  # Text Search - Full-text with fuzzy matching
  - name: "memory_text_search"
    description: "Full-text search with optional fuzzy matching"
    backend:
      endpoint: "/api/nginx-memory/text"
      method: "POST"
    inputSchema:
      type: "object"
      properties:
        query:
          type: "string"
          description: "Text to search for"
        node_types:
          type: "array"
          items:
            type: "string"
          description: "Filter by node types"
        properties:
          type: "array"
          items:
            type: "string"
          description: "Specific properties to search"
        fuzzy:
          type: "boolean"
          description: "Enable fuzzy matching"
          default: false
        limit:
          type: "number"
          default: 10
      required: ["query"]

  # Get Schema - Database structure discovery
  - name: "memory_get_schema"
    description: "Get memory schema with vocabulary guidance"
    backend:
      endpoint: "/api/nginx-memory/schema"
      method: "GET"
    inputSchema:
      type: "object"
      properties:
        include_statistics:
          type: "boolean"
          description: "Include node/relationship counts"
          default: false

  # System Status - Health check
  - name: "memory_system_status"
    description: "Check memory system health"
    backend:
      endpoint: "/api/nginx-memory/status"
      method: "GET"
    inputSchema:
      type: "object"
      properties: {}

  # Load Current Focus - Consciousness continuity
  - name: "memory_load_current_focus"
    description: "Load consciousness context for session continuity"
    backend:
      endpoint: "/api/nginx-memory/focus"
      method: "GET"
    inputSchema:
      type: "object"
      properties: {}

  # Execute Cypher - Direct Neo4j query
  - name: "memory_execute_cypher"
    description: "Execute a Cypher query against the knowledge graph"
    backend:
      endpoint: "/api/nginx-memory/cypher"
      method: "POST"
    inputSchema:
      type: "object"
      properties:
        query:
          type: "string"
          description: "Cypher query to execute"
        mode:
          type: "string"
          enum: ["READ", "WRITE"]
          description: "Query mode - READ or WRITE"
        parameters:
          type: "object"
          description: "Query parameters"
        client_schema_epoch:
          type: "number"
          description: "Schema version for write safety"
      required: ["query", "mode"]

# Backend routing rules
# For more complex scenarios, you can define routing based on patterns
routing:
  # HTTP REST backends (direct access via /api/{service}/)
  http_backends:
    nginx-memory: "http://localhost:5001"  # POC backend

  # Backend URLs for function-based /execute routing (legacy)
  backends:
    memory: "http://localhost:3003"
    mesh: "http://localhost:3002"
    recall: "http://localhost:3006"

  # Route by tool name prefix (legacy endpoint-based routing)
  prefixes:
    "memory_": "http://localhost:5001"  # POC backend
    "mesh_": "http://mesh-service:3002"
    "facts_": "http://facts-service:3003"

  # Fallback for unmatched tools
  default: "http://localhost:5001"

# Health check endpoints
health:
  gateway: "/health"
  backends:
    - name: "memory"
      url: "http://memory-service:3001/health"
    - name: "mesh"
      url: "http://mesh-service:3002/health"
    - name: "facts"
      url: "http://facts-service:3003/health"
