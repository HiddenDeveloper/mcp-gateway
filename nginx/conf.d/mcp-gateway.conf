# NGINX MCP Gateway Server Block
# Include this in your nginx.conf: include /path/to/nginx-mcp-gateway/nginx/conf.d/*.conf;

# Import njs handler - UPDATE THIS PATH
js_import mcp from /Users/monyet/develop/home/nginx-mcp-gateway/nginx/njs/mcp-handler.js;

# Upstream backends
upstream default_backend {
    server localhost:8080;
    keepalive 32;
}

# MCP Gateway Server
server {
    listen 3000;
    server_name mcp-gateway;

    # Logging
    access_log /opt/homebrew/var/log/nginx/mcp-access.log;
    error_log /opt/homebrew/var/log/nginx/mcp-error.log;

    # Health check
    location /health {
        access_log off;
        return 200 '{"status":"healthy","service":"nginx-mcp-gateway"}';
        add_header Content-Type application/json;
    }

    # Initialize handler (load tools.json)
    location /init {
        js_content mcp.init;
    }

    # Main MCP endpoint - HTTP POST for JSON-RPC
    location /mcp {
        # CORS headers for browser clients
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Content-Type, Authorization' always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Process MCP requests via njs
        js_content mcp.handleMCPRequest;
    }

    # SSE endpoint for streaming responses (future)
    location /mcp/sse {
        js_content mcp.handleSSE;

        # SSE-specific settings
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 24h;
    }

    # Internal backend proxy locations
    # These are called by the njs handler via subrequest

    location /backend/ {
        internal;
        proxy_pass http://default_backend/;
        proxy_set_header Content-Type application/json;
        proxy_set_header Host $host;
    }
}
